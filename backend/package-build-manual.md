# 打包指南

![OSS](https://static.cnbetacdn.com/article/2018/0821/6516ac17b422c31.png)

- 当前应用部署流程中，dev 开发环境的包名为写死状态，每次生成的包名为项目名.jar，test/prod 环境为管理版本，需要从应用内部读取版本号，配合项目名在每次打包时生成唯一的 jar 包名。
- 结合以上实际情况，对项目打包做如下约定。

## 1 开发环境打包

- 开发环境不支持版本管理，不用修改版本号，但是建议结合当前提交的 PR 中对程序的修改内容写出一条更新语句，放到 update.md 中
- 开发环境打包默认从 master 分支拉取代码

## 2 测试/正式环境打包

- 测试/正式环境进行严格的包版本管理，在向这两个环境提交代码时，必须严格遵循以下步骤

### Step 1: 递增修改 application_version.gradle 下的版本号

```text
version = 'v2.0.1'
jar {
  archivesBaseName = 'tmc-services'
}
```

- 如上，现版本号为 v2.0.1，建议向 test 环境提交代码时更改最后一位数字，即改为 v2.0.2

### Step 2: 修改 update.md 文档

```text
# 版本升级基本内容
- 当前版本 v2.0.2
- 替换版本 v2.0.1
- 替换操作: 
    - 登录流程中加入了验证码元素，当登录失败超过三次需要输入验证码，最后一次输入错误15分钟后可不用输入验证码
- 回滚操作
```

- 如上，所写内容应概括本次提交中的要点。
  - 版本号仅在向 test 提交的那一次进行更改。
  - 当多人协作在 dev 环境开发时，每次向 dev 环境的代码提交也应如实记录提交内容。
  - 等到某次向 test 环境提交代码时，之前多次在 dev 开发中提交在 update.me 文档中的记录可作为本次 test 提交的记录。
  - 向 test 环境提交代码成功后，程序员有责任清空 update.md 中**替换操作**和**回滚操作**中的内容，方便下一波 dev 迭代开发过程中的更新记录。
  - 向 prod 提交代码时，应整理之前的 update 记录，进行提炼，总结出本次正式环境发版的更新内容。

### Step 3: 提交代码到 release 分支

- 运维默认从 release 分支向测试/正式环境拉取打包代码，故在向 master 分支发起 PR 并合并代码饿基础上，应再向 release 分支合并代码。

### Step 4: 通知运维打包

- 运维编写自动化工具检测 release 分支变化，自动拉取代码亦可。
